# OpsMap Agent - Multi-stage build
# Produces a minimal ~5MB static binary

# Build stage
FROM rust:1.75-alpine AS builder

# Install build dependencies
RUN apk add --no-cache musl-dev openssl-dev openssl-libs-static pkgconfig

WORKDIR /build

# Copy Cargo files first for dependency caching
COPY agent/Cargo.toml agent/Cargo.lock* ./

# Create dummy source for dependency compilation
RUN mkdir src && echo "fn main() {}" > src/main.rs

# Build dependencies only
RUN cargo build --release --target x86_64-unknown-linux-musl 2>/dev/null || true

# Remove dummy source
RUN rm -rf src

# Copy actual source
COPY agent/src ./src

# Build release binary
RUN cargo build --release --target x86_64-unknown-linux-musl

# Strip binary for smaller size
RUN strip /build/target/x86_64-unknown-linux-musl/release/opsmap-agent

# Runtime stage - minimal image
FROM scratch

# Copy CA certificates for TLS
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# Copy binary
COPY --from=builder /build/target/x86_64-unknown-linux-musl/release/opsmap-agent /opsmap-agent

# Create directories for config and certs
VOLUME ["/etc/opsmap", "/var/lib/opsmap", "/var/log/opsmap"]

# Run as non-root
USER 1000:1000

ENTRYPOINT ["/opsmap-agent"]
CMD ["--config", "/etc/opsmap/agent.yaml"]
