name: CVE Scan

on:
  # Run daily
  schedule:
    - cron: '0 6 * * *'
  # Manual trigger
  workflow_dispatch:
  # On push to main
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  scan-dependencies:
    name: Scan Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.component }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.component }}
        run: npm ci

      # NPM Audit - fails on high/critical
      - name: NPM Audit
        working-directory: ${{ matrix.component }}
        run: npm audit --audit-level=high

      # Trivy filesystem scan
      - name: Run Trivy filesystem scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: ${{ matrix.component }}
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          format: 'table'

      # Snyk security scan (optional, requires SNYK_TOKEN secret)
      - name: Snyk vulnerability scan
        if: ${{ env.SNYK_TOKEN != '' }}
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=${{ matrix.component }}/package.json

  scan-images:
    name: Scan Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        image:
          - name: backend
            ref: ghcr.io/${{ github.repository }}/backend:latest
          - name: frontend
            ref: ghcr.io/${{ github.repository }}/frontend:latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        run: docker pull ${{ matrix.image.ref }}

      # Trivy image scan (table for log visibility)
      - name: Trivy vulnerability scanner (log)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.ref }}
          scanners: 'vuln'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          format: 'table'
          ignore-unfixed: true

      # Trivy image scan (SARIF for GitHub Security tab)
      - name: Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.ref }}
          scanners: 'vuln'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true
          format: 'sarif'
          output: '${{ matrix.image.name }}-trivy.sarif'
          limit-severities-for-sarif: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: '${{ matrix.image.name }}-trivy.sarif'

      # Grype image scan (alternative scanner)
      - name: Grype vulnerability scanner
        uses: anchore/scan-action@v3
        with:
          image: ${{ matrix.image.ref }}
          severity-cutoff: high
          fail-build: true
          output-format: sarif

  scan-manifests:
    name: Scan Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Trivy config scan for K8s manifests
      - name: Trivy K8s manifest scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'deploy/kubernetes'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          format: 'table'

      # Checkov for IaC scanning
      - name: Checkov IaC scanner
        uses: bridgecrewio/checkov-action@master
        with:
          directory: deploy/kubernetes
          framework: kubernetes
          soft_fail: false
          skip_check: CKV_K8S_43  # Allow image with latest tag for dev

      # Kubescape security scan
      - name: Kubescape scanner
        uses: kubescape/github-action@main
        with:
          files: deploy/kubernetes
          severityThreshold: high
          failedThreshold: 0

  notify-on-failure:
    name: Notify on Vulnerability Found
    runs-on: ubuntu-latest
    needs: [scan-dependencies, scan-manifests]
    if: failure()
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Security Scan Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Security Scan Failure

            The scheduled security scan has found vulnerabilities that need attention.

            **Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please review the scan results and take appropriate action:
            1. Update vulnerable dependencies
            2. Review and fix Kubernetes manifest security issues
            3. Rebuild and redeploy affected images

            /cc @security-team
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            const existingIssue = issues.data.find(i => i.title.startsWith('Security Scan Failed'));

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `New scan failure detected at ${new Date().toISOString()}\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['security', 'automated', 'high-priority']
              });
            }
